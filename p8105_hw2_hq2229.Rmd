---
title: "p8105_hw2_hq2229"
author: "Hantang Qin"
output: github_document
date: "2025-09-28"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Problem1 

Clean csv
```{r}

library(tidyverse)
library(janitor)
library(lubridate)

pols <- read_csv("fivethirtyeight_datasets/pols-month.csv", show_col_types = FALSE) %>%
  separate(mon, into = c("year", "month_num", "day"), convert = TRUE) %>%
  mutate(
    month    = month.name[month_num],
    president = if_else(prez_gop == 1, "gop", "dem")
  ) %>%
  select(year, month, gov_gop, gov_dem, sen_gop, sen_dem, rep_gop, rep_dem, president)

snp <- read_csv("fivethirtyeight_datasets/snp.csv", show_col_types = FALSE) %>%
  mutate(date = mdy(date)) %>%                     
  transmute(
    year  = year(date),
    month = as.character(month(date, label = TRUE, abbr = TRUE)),   
    month = month.name[match(month, month.abb)],                   
    close
  ) %>%
  arrange(year, match(month, month.name))

unemp <- read_csv("fivethirtyeight_datasets/unemployment.csv", show_col_types = FALSE) %>%
  pivot_longer(
    cols = Jan:Dec,
    names_to = "month_abbr",
    values_to = "unemployment_rate"
  ) %>%
  mutate(
    month = month.name[match(month_abbr, month.abb)],
    year  = as.integer(Year)
  ) %>%
  select(year, month, unemployment_rate)

final_data <- pols %>%
  left_join(snp,   by = c("year", "month")) %>%
  left_join(unemp, by = c("year", "month")) %>%
  arrange(year, match(month, month.name))

p1_n_obs   <- nrow(final_data)
p1_n_vars  <- ncol(final_data)
p1_yearmin <- min(final_data$year, na.rm = TRUE)
p1_yearmax <- max(final_data$year, na.rm = TRUE)


```

After cleaning and merging, the final monthly panel has **`r p1_n_obs` observations** and **`r p1_n_vars` variables**, spanning **`r p1_yearmin`–`r p1_yearmax`**.  
Key variables include political control (`president`, plus `gov_*`, `sen_*`, `rep_*`), the **S&P closing value** (`close`), and the **unemployment rate** (`unemployment_rate`).  
Putting everything in one tidy dataset makes it easy to line up political changes with market and labor indicators over time.

Problem 2
```{r}

library(tidyverse)
library(readxl)
library(janitor)
library(lubridate)

trash_xlsx <- "202509 Trash Wheel Collection Data.xlsx"

Mr_trash_wheel =
  read_excel(
    trash_xlsx,
    sheet = "Mr. Trash Wheel",
    range = "A2:N709"
  ) |>
  janitor::clean_names() |>
  mutate(
    sports_balls = as.integer(round(sports_balls)),
    type = "Mr. Trash Wheel",
    year = as.character(year)
  ) |>
  select(date, type, everything(), -dumpster)

Professor_trash_wheel =
  read_excel(
    trash_xlsx,
    sheet = "Professor Trash Wheel",
    range = "A2:M134"
  ) |>
  janitor::clean_names() |>
  mutate(
    type = "Professor Trash Wheel",
    year = as.character(year)
  ) |>
  select(date, type, everything(), -dumpster)

Gwynns_trash_wheel =
  read_excel(
    trash_xlsx,
    sheet = "Gwynns Falls Trash Wheel",
    range = "A2:L351"
  ) |>
  janitor::clean_names() |>
  mutate(
    type = "Gwynnda Trash Wheel",
    year = as.character(year)
  ) |>
  select(date, type, everything(), -dumpster)

trash_wheel =
  bind_rows(Mr_trash_wheel, Professor_trash_wheel, Gwynns_trash_wheel) |>
  arrange(date)

tw_n_obs      <- nrow(trash_wheel)
tw_n_devices  <- dplyr::n_distinct(trash_wheel$type)

tw_prof_total_tons <-
  Professor_trash_wheel |>
  summarise(total = sum(weight_tons, na.rm = TRUE)) |>
  pull(total) |>
  round(2)

tw_gwyn_jun22_cigs <-
  Gwynns_trash_wheel |>
  filter(year == "2022", month == "June") |>
  summarise(total = sum(cigarette_butts, na.rm = TRUE)) |>
  pull(total)


```

The cleaned dataset includes **`r tw_n_obs` observations** from **`r tw_n_devices` trash wheels**: Mr. Trash Wheel, Professor Trash Wheel, and Gwynnda Trash Wheel. Each entry records the device `type`, the `date`, and measures of trash collected, including `weight_tons`, `volume_cubic_yards`, and counts such as `plastic_bottles`, `polystyrene`, and `cigarette_butts`.  In terms of totals, **Professor Trash Wheel** has collected **`r tw_prof_total_tons` tons** of trash overall. Meanwhile, **Gwynnda** picked up **`r format(tw_gwyn_jun22_cigs, big.mark = ",")` cigarette butts** just in June 2022.  






Problem 3
```{r}

library(tidyverse)
library(janitor)
library(lubridate)
library(stringr)
library(knitr)

borough_map <- c(
  "New York" = "Manhattan",
  "Kings"    = "Brooklyn",
  "Queens"   = "Queens",
  "Bronx"    = "Bronx",
  "Richmond" = "Staten Island"
)
zip_ref <-
  read_csv("zillow_data/Zip Codes.csv", na = c("NA", ".", ""), show_col_types = FALSE) |>
  clean_names() |>
  mutate(
    zip_code = as.character(zip_code),
    county   = as.character(county)
  )


zori_raw <-
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv",
           na = c("NA", ".", ""), show_col_types = FALSE) |>
  clean_names() |>
  mutate(
    county_name = str_remove(county_name, " County$")
  ) |>
  rename_with(~ str_remove(.x, "^x"), .cols = starts_with("x")) |>
  rename(zip_code = region_name, county = county_name) |>
  filter(!if_all(matches("^\\d{4}_\\d{2}_\\d{2}$"), is.na)) |>
  select(zip_code, county, any_of(c("region_id","size_rank")), matches("^\\d{4}_\\d{2}_\\d{2}$")) |>
  mutate(
    zip_code = as.character(zip_code),
    county   = as.character(county)
  )

joint_data <-
  right_join(zip_ref, zori_raw, by = c("zip_code","county")) |>
  pivot_longer(
    cols      = matches("^\\d{4}_\\d{2}_\\d{2}$"),
    names_to  = "date_chr",
    values_to = "price"
  ) |>
  mutate(
    date    = ymd(str_replace_all(date_chr, "_", "-")),
    borough = recode(county, !!!borough_map)
  ) |>
  select(any_of(c(
    "state","city","county","borough","state_fips","county_fips","county_code","metro",
    "neighborhood","zip_code","region_id","size_rank","date","price","file_date"
  ))) |>
  arrange(zip_code, date)


p3_n_obs          <- nrow(joint_data)
p3_n_zip          <- n_distinct(joint_data$zip_code)
p3_n_neighborhood <- n_distinct(joint_data$neighborhood)
p3_date_min       <- suppressWarnings(min(joint_data$date, na.rm = TRUE))
p3_date_max       <- suppressWarnings(max(joint_data$date, na.rm = TRUE))


zips_missing <- anti_join(
  zip_ref |> select(any_of(c("zip_code","county","neighborhood","city","state"))),
  zori_raw |> select(zip_code, county),
  by = c("zip_code","county")
)
n_missing_zips   <- nrow(zips_missing)
missing_examples <- head(zips_missing$zip_code, 5)


drops_20_21 <-
  zori_raw |>
  transmute(
    zip_code, county,
    drop_2020_to_2021 = `2020_01_31` - `2021_01_31`
  ) |>
  filter(!is.na(drop_2020_to_2021)) |>
  left_join(zip_ref |> select(zip_code, any_of("neighborhood")), by = "zip_code") |>
  mutate(borough = recode(county, !!!borough_map))

top10_largest_drop <-
  drops_20_21 |>
  arrange(desc(drop_2020_to_2021)) |>
  select(zip_code, borough, neighborhood, county, drop_2020_to_2021) |>
  slice_head(n = 10)


top10_range <-
  joint_data |>
  group_by(zip_code) |>
  filter(any(!is.na(price))) |>
  summarise(
    price_max   = max(price, na.rm = TRUE),
    price_min   = min(price, na.rm = TRUE),
    price_range = price_max - price_min,
    .groups = "drop"
  ) |>
  arrange(desc(price_range)) |>
  slice_head(n = 10) |>
  left_join(zip_ref |> select(zip_code, any_of(c("neighborhood","county"))), by = "zip_code") |>
  mutate(borough = recode(county, !!!borough_map)) |>
  relocate(borough, neighborhood, county, .after = zip_code)

kable(top10_largest_drop,
     caption = "Top 10 ZIP codes by largest ZORI drop (Jan 2020 → Jan 2021; drop = 2020 − 2021)")

kable(zips_missing |> slice_head(n = 10),
     caption = "Examples: ZIPs present in ZIP file but missing from ZORI dataset")

kable(top10_range,
     caption = "Top 10 ZIP codes by overall ZORI range")

```
The final tidy dataset has **`r p3_n_obs` observations** across **`r p3_n_zip` ZIP codes**
and **`r p3_n_neighborhood` neighborhoods**, spanning **`r p3_date_min`** to **`r p3_date_max`**.
There are **`r n_missing_zips` ZIP codes** in the reference that don’t appear in ZORI
(e.g., `r paste(missing_examples, collapse = ", ")`), likely PO-box or non-residential areas.
The largest pandemic-era drop (Jan 2020 → Jan 2021) and the widest overall range are shown
in the tables above.


For the change between January 2020 and January 2021, the sharpest drop in rental prices was about 912.5966 dollars in Lower Manhattan. Looking over the entire time period, the largest overall decline was close to 3001.010 dollars, also in Lower Manhattan. Both patterns show how dramatically the COVID-19 pandemic disrupted the rental market.

